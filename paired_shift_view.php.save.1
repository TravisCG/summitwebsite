<?php
$servername = "localhost";
$username = "sciguest";
$password = "password";
$dbname = "summitdb";
$motivePart = $_GET['motive'];
$motifid = $_GET['motifid'];
$motiveplus = $motifid + 100;
$motiveName = '\''.$motivePart.'\'';
$exp1 = $_GET['exp1'];
$exp1Name = '\''.$exp1.'\'';
$exp2 = $_GET['exp2'];
$exp2Name = '\''.$exp2.'\'';
$exp3 = $_GET['exp3'];
$exp3Name = '\''.$exp3.'\'';
$limit = $_GET['limit'];
$low_limit = $_GET['low_limit'];
$complex_id1 = '"' . $motiveplus . $exp1 . '"';
$complex_id2 = '"' . $motiveplus . $exp2 .  '"';
$complex_id3 = '"' . $motiveplus . $exp3 .  '"';
$minelem = $_GET['formminelem'];
$minName = '\''.$minelem.'\'';

// Create connection
$conn = new mysqli($servername, $username, $password, $dbname);
// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

//queries
$sql ="SELECT distance, count 
FROM new_paired_shift_view
where paired_shift_id = $complex_id1
&& distance <= $limit +2
&& distance >=  $low_limit -2
ORDER BY distance"; 

$sql2 = "SELECT distance, count 
FROM new_paired_shift_view
where paired_shift_id = $complex_id2
&& distance <= $limit + 2
&& distance >=  $low_limit - 2
ORDER BY distance";

$sql3 = "SELECT distance, count 
FROM new_paired_shift_view
where paired_shift_id = $complex_id3
&& distance <= $limit + 2
&& distance >=  $low_limit - 2
ORDER BY distance";

$sql4 = "SELECT experiment.experiment_id, experiment.name AS name, experiment.antibody_antibody_id AS antibody_id, experiment.cell_lines_cellline_id
FROM experiment
LEFT JOIN average_deviation on average_deviation.experiment_experiment_id = experiment.experiment_id
WHERE average_deviation.element_num > $minName
&& average_deviation.consensus_motif_motif_id = $motifid;";

$sql5 = "SELECT , motif_id 
FROM consensus_motif WHERE name = $motivePart";

$sql6 = "SELECT name, motif_id 
FROM consensus_motif";

$sql7 = "SELECT DISTINCT cell_lines_cellline_id, cell_lines.name AS cell_line 
FROM experiment 
LEFT JOIN antibody ON antibody.antibody_id = experiment.antibody_antibody_id 
LEFT JOIN cell_lines ON cell_lines.cellline_id = experiment.cell_lines_cellline_id
ORDER BY cell_line";

$sql8 = "SELECT DISTINCT  antibody.name AS antibody, experiment.antibody_antibody_id AS antibody_id, GROUP_CONCAT(cell_lines.cellline_id SEPARATOR ' ') AS cellline_id
FROM experiment 
LEFT JOIN antibody ON antibody.antibody_id = experiment.antibody_antibody_id 
LEFT JOIN cell_lines ON cell_lines.cellline_id = experiment.cell_lines_cellline_id
group by antibody_antibody_id, antibody
ORDER BY antibody";

//generating results

$result = $conn->query($sql);
$result2 = $conn->query($sql2);
$result3 = $conn->query($sql3);
$result4 = $conn->query($sql4);
$result5 = $conn->query($sql5);
$result6 = $conn->query($sql6);
$result7 = $conn->query($sql7);
$result8 = $conn->query($sql8);



//genrating data into jsondata

while($r = mysqli_fetch_assoc($result)) {
    $jsonData[] = $r;
}

while($w = mysqli_fetch_assoc($result2)) {
    $jsonData2[] = $w;}


while($e = mysqli_fetch_assoc($result3)) {
    $jsonData3[] = $e;}


while($es = mysqli_fetch_assoc($result4)) {
    $jsonData4[] = $es;}

while($ews = mysqli_fetch_assoc($result5)) {
    $jsonData5[] = $ews;}


while($ew6 = mysqli_fetch_assoc($result6)) {
    $jsonData6[] = $ew6;}
$conn->close();

while($ew7 = mysqli_fetch_assoc($result7)) {
    $jsonData7[] = $ew7;}
$conn->close();

while($ew8 = mysqli_fetch_assoc($result8)) {
    $jsonData8[] = $ew8;}
$conn->close();
 

?>

<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>NAIK Genome Database</title>
<link href="favicon.png" rel="icon"  type="image/png" />
<meta name="Description" content="A database containing genomic data that was analysed and meta analysed by the Bioinformatics Research Group of the NAIK MBK.">

<link rel="stylesheet" type="text/css" href="style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>

</head>

<body>


<div class="container_16">
<!--topdiv -->

  <a href="https://www.edu.unideb.hu/"><img src="University_logo.png" alt="SummitDB"  title="SummitDB" class="logo"/></a>
  <img src="logo.gif" alt="SummitDB"  title="SummitDB" class="logomid"/>
  <a href="http://www.naik.hu/en/"><img src="naik-logo.png" alt="SummitDB"  title="SummitDB" class="logo2"/>

  </a>
</div>

  <div class="foo">
    <ul class="navlink">
        <li><a href="main.html" title="Home" class="active">Home</a></li>
        <li><a  title="Help">Help</a></li>
    </ul>
        </div>

 
	<?php echo " <h4 style='margin:auto;text-align:center;font-size:1.3em;padding-bottom:2em;padding-top:9em;'>	Shift values are shown using the ". $motiveName . " motive's center as point zero.</h4><br>" ?>


<div id="chart" style="width:94% ;background-color: white;border:1px solid black;display:block;float:none;" >
</div>

<div name="logo_chart"  id="logo_chart" style="width:94%; background-color: white;height: 8em;border:1px solid black; ">
	<?php echo "<img src=\"./logos/" . $motivePart . ".jpg\" style=\"width:15%;height:95%;opacity=30%;margin-left: 1em;margin-right: 1px;margin-top: 1px;float:left;\"> " ?>
<p style="float:left">Position weight matrix of selected motif.</p>
</div>


<script>
var margin = {top: 20, right: 20, bottom: 30, left: 60},
    width = 1400 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;
var legendtitle = 420;
var maxShift = 99;

var data = <?php 
if (json_encode($jsonData, JSON_NUMERIC_CHECK) == 'null'){ 
echo '[{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0}]'; 
}else {
echo json_encode($jsonData, JSON_NUMERIC_CHECK);
};
?>;

var data2 = <?php 
if (json_encode($jsonData2, JSON_NUMERIC_CHECK) == 'null'){ 
echo '[{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0}]'; 
}else {
echo json_encode($jsonData2, JSON_NUMERIC_CHECK);
};
?>;

var data3 = <?php 
if (json_encode($jsonData3, JSON_NUMERIC_CHECK) == 'null'){ 
echo '[{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0},{"distance":0,"count":0}]'; 
}else {
echo json_encode($jsonData3, JSON_NUMERIC_CHECK);
};
?>;

var data4 = <?php echo json_encode($jsonData4, JSON_NUMERIC_CHECK);?>;
var data5 = <?php echo json_encode($jsonData5, JSON_NUMERIC_CHECK);?>;
var ujtomb = <?php echo json_encode($ujtomb);?>;
var motive = <?php echo "\"" . $motivePart . "\""; ?>;
</script>

<script src="urlgetter.js">//this one gets the options out of the url and make them an object
</script>

<script src="drawallshift.js">//this draws the canvas itself
</script>

<script src="dosearch.js">//this searches the brackets and makes the new url THE NEW URL IS HERE? IF IT HAS TO BE MODIFIED!!!! 
</script>

<script src="buttons.js">//this will make the buttons work
</script>

<script>
//this trims the array in this case for the options
function trimArray(arr)
{
    for(i=0;i<arr.length;i++)
    {
        arr[i] = arr[i].replace(/^\s\s*/, '').replace(/\s\s*$/, '');
    }
    return arr;
}
</script>
<script>
var formmaxid = getAllUrlParams().formmaxid;
document.getElementById("textboxmax").value = formmaxid;

var formminid = getAllUrlParams().formminid;
document.getElementById("textboxmin").value = formminid;

var formminelem = getAllUrlParams().formminelem;
document.getElementById("textboxamnelem").value = formminelem;

var formmaxelem = getAllUrlParams().formmaxelem;
document.getElementById("textboxminelem").value = formmaxelem;

</script>
<script src="urlgetter.js">//this one gets the options out of the url and make them an object
</script>




<br>
<div>
<br>
<br>
<br>


<p>Set the three experiments. You can narrow down the experiment by choosing the cell line and the antibody for it:</p><br>

<div>

<div class="wrapper1" style="height:4em;">
<p class="one">cell type</p>
<p class="two">antibody</p>
<p class="three">experiment name</p>

</div>



<div class="wrapper">

<select id="cellformexp1" class="one" type="text" value="" placeholder="Type to filter" style="background:#ff6666;">

<?php 
//this one puts ALL the options in the select area

foreach($jsonData7 as $item){
    echo "<option value=".  $item['cell_lines_cellline_id']  . " class=\"formexp1\">" . $item['cell_line'] . "</option>" ;    // process the line read.
    }
?>
</select>


<select id="antiformexp1" type="text" class="two" value="" placeholder="Type to filter" style="background:#ff6666;">

<?php 
//this one puts ALL the options in the select area

foreach($jsonData8 as $item){
    echo "<option value=".  $item['antibody_id'] . " data-celline=" . "\"" .  $item['cellline_id'] . "\"" . " disabled=\"disabled\">" . $item['antibody'] . "</option>" ;    // process the line read.
    }
?>
</select>

<select id="formexp1" type="text" value="" class="three" placeholder="Type to filter"  style="background:#ff6666;">
<?php 
//this one puts ALL the options in the select area

foreach($jsonData4 as $item){
    echo "<option class=\"cell_unselected\" value=". $item['experiment_id'] . " data-celline=". $item['cell_lines_cellline_id']. " data-antibody=" 
    . $item['antibody_id'] . " disabled=\"disabled\" >" . $item['name'] . "</option>" ;    // process the line read.
    }
?>

</select>
<br>
<button class="threeAH" onclick="jumptoexp1()"> experiment view </button>


<select id="cellformexp2" type="text" class="four" value="" placeholder="Type to filter" style="background:#6666ff;">

<?php 
//this one puts ALL the options in the select area

foreach($jsonData7 as $item){
    echo "<option value=".  $item['cell_lines_cellline_id'] .  " class=\"formexp2\">" . $item['cell_line'] . "</option>" ;    // process the line read.
    }
?>
</select>



<select id="antiformexp2" type="text" class="five" value="" placeholder="Type to filter" style="background:#6666ff;">

<?php 
//this one puts ALL the options in the select area

foreach($jsonData8 as $item){
    echo "<option value=".  $item['antibody_id'] .  " data-celline=" . "\"" .  $item['cellline_id'] . "\"" . "  disabled=\"disabled\">" . $item['antibody'] . "</option>" ;    // process the line read.
    }
?>
</select>



 <select id="formexp2" type="text" class="six" value=""  placeholder="Type to filter" style="background:#6666ff;">

<?php
//this one puts ALL the options in the select area
foreach($jsonData4 as $item){
    echo "<option class=\"cell_unselected\" value=". $item['experiment_id'] . " data-celline=". $item['cell_lines_cellline_id']. " data-antibody=" 
    . $item['antibody_id'] . " disabled=\"disabled\" >" . $item['name'] . "</option>" ;    // process the line read.
    }

?>
</select>
<button class="sixAH" onclick="jumptoexp2()"> experiment view </button>

<br>

<select id="cellformexp3" type="text" value="" class="seven" placeholder="Type to filter" style="background:#66ff66;">

<?php 
//this one puts ALL the options in the select area

foreach($jsonData7 as $item){
    echo "<option value=".  $item['cell_lines_cellline_id'] .  " class=\"formexp2\">" . $item['cell_line'] . "</option>" ;    // process the line read.
    }
?>
</select>


<select id="antiformexp3" type="text" value="" class="eight" placeholder="Type to filter" style="background:#66ff66;">

<?php 
//this one puts ALL the options in the select area

foreach($jsonData8 as $item){
    echo "<option value=".  $item['antibody_id'] .  " data-celline=" . "\"" .  $item['cellline_id'] . "\"" . "  disabled=\"disabled\">" . $item['antibody'] . "</option>" ;    // process the line read.
    }
?>
</select>

<select id="formexp3" type="text" value="" class="nine" placeholder="Type to filter" style="background:#66ff66;">
<?php

foreach($jsonData4 as $item){
    echo "<option class=\"cell_unselected\" value=". $item['experiment_id'] . " data-celline=". $item['cell_lines_cellline_id']. " data-antibody=" 
    . $item['antibody_id'] . " disabled=\"disabled\" >" . $item['name'] . "</option>" ;    // process the line read.
    }

?>
</select>
<button class="nineAH" onclick="jumptoexp3()"> experiment view </button>

<br>
<script>
//makes the three jump to experiment view buttons work
function jumptoexp1() {
   var firstexp1 = '';
    var firstexp1 = parseInt(document.getElementById("formexp1").value) || "undefined";
var adresshift = "http://genomics.dote.hu/summitdb/experiment_view.php?exp=" + encodeURIComponent(firstexp1);

window.open(adresshift, '_blank');
}

function jumptoexp2() {
   var firstexp2 = '';
    var firstexp2 = parseInt(document.getElementById("formexp2").value) || "undefined";
var adresshift = "http://genomics.dote.hu/summitdb/experiment_view.php?exp=" + encodeURIComponent(firstexp2);

window.open(adresshift, '_blank');
}

function jumptoexp3() {
   var firstexp3 = '';
    var firstexp3 = parseInt(document.getElementById("formexp3").value) || "undefined";
var adresshift = "http://genomics.dote.hu/summitdb/experiment_view.php?exp=" + encodeURIComponent(firstexp3);

window.open(adresshift, '_blank');
}



//this thing will help the preselect trim the experiment selection
 $( document ).ready(function() {
$('select#antiformexp1').change(function(){
$("select#formexp1 option").attr('disabled', false);

$(  "select#formexp1 " +  "option:not([data-antibody='" +  $("#antiformexp1").val() + "'])" )
    .attr( "disabled", "disabled" )

  });
}); 

 $( document ).ready(function() {
$('select#antiformexp2').change(function(){
$("select#formexp2 option").attr('disabled', false);

$(  "select#formexp2 " +  "option:not([data-antibody='" +  $("#antiformexp2").val() + "'])" )
        .attr( "disabled", "disabled" )

  });
}); 

 $( document ).ready(function() {
$('select#antiformexp3').change(function(){
$("select#formexp3 option").attr('disabled', false);


$(  "select#formexp3 " +  "option:not([data-antibody='" +  $("#antiformexp3").val() + "'])" )
        .attr( "disabled", "disabled" )

  });
}); 

 $( document ).ready(function() {
$('select#cellformexp1').change(function(){

$("select#formexp1 option").removeClass("cell_unselected");
$("select#formexp1 " + "option:not([data-celline='" + $("#cellformexp1").val() + "'])" ).addClass("cell_unselected");

$("select#antiformexp1 option").attr('disabled', 'disabled');
$(  "select#antiformexp1 " +  "option[data-celline~=\"" +  $("#cellformexp1").val() + "\"]" )
        .attr( 'disabled', false )

  });
}); 

 $( document ).ready(function() {
$('select#cellformexp2').change(function(){

$("select#formexp2 option").removeClass("cell_unselected");
$("select#formexp2 " + "option:not([data-celline='" + $("#cellformexp2").val() + "'])" ).addClass("cell_unselected");

$("select#antiformexp2 option").attr('disabled', 'disabled');
$(  "select#antiformexp2 " +  "option[data-celline~=\"" +  $("#cellformexp2").val() + "\"]" )
        .attr( 'disabled', false )

  });
}); 

 $( document ).ready(function() {
$('select#cellformexp3').change(function(){

$("select#formexp3 option").removeClass("cell_unselected");
$("select#formexp3 " + "option:not([data-celline='" + $("#cellformexp3").val() + "'])" ).addClass("cell_unselected");

$("select#antiformexp3 option").attr('disabled', 'disabled');
$(  "select#antiformexp3 " +  "option[data-celline~=\"" +  $("#cellformexp3").val() + "\"]" )
        .attr( 'disabled', false )

  });
}); 



</script>


</div>

<p>Here you will be able to set the upper and bottom limit of the distance shown. (the parameter set here is the max x and the negative of the minimum x value) </p>

<br>
<p>distance from motif center maximum</p>
<input id="limit" type="number" min="20" max="35" step="5">
<br>
<p>distance from motif center minimum</p>
<input id="low_limit" type="number" min="-35" max="-20" step="5">

<br>


<p>Set a motif:</p><br>
  <select id="formmotive" type="text" value="" placeholder="Type to filter">
<?php
//this one puts ALL the options in the select area
foreach($jsonData6 as $item){
     echo "<option value=". $item['motif_id'] .">" . $item['name'] . "</option>" ;    // process the line read.
    }
?>
</select>

<p>Minimum standard deviation</p>
<form action="#"> <input type="text" id="textboxmin" value="integer please">
</form>

<p>Maximum standard deviation</p>

<form action="#"> <input type="text" id="textboxmax" value="integer please">
</form>

<p>Minimum overlap number between motifs and peaks of experiment</p>

<form action="#"> <input type="text" id="textboxmnelem" value="integer please">
</form>

<p>Maximum overlap number between motifs and peaks of experiment</p>

<form action="#"> <input type="text" id="textboxmxelem" value="integer please">
</form>


<p>When te parameters have been set, this button will refresh the page.</p>

<button id="resend" onclick="doSearchShift()" style="width: 14em;"><p>Resend Data</p></button>

<button id="venn" onclick="goToVenn()" style="width: 14em;"><p>Go to venn diagramm</p></button>

function jumptoexp3() {
   var firstexp1 = '';
    var firstexp1 = getAllUrlParams().exp1;
   var firstexp2 = '';
    var firstexp2 = getAllUrlParams().exp2;
   var firstexp3 = '';
    var firstexp3 = getAllUrlParams().exp3;
var adresshift = "http://genomics.dote.hu/summitdb/experiment_view.php?exp=" + encodeURIComponent(firstexp3);

window.open(adresshift, '_blank');
}

</div>


<br>
<br>





<script>

$(document).ready(function(){
$(".deletefirst").click(function(event){
 $('.'+  $(this).data('targets')).toggle();
});
});

//this thing will help the preselect trim the experiment selection
/*
$( document ).ready(function() {
$('select#antiformexp1').change(function(){
$( "option:not('.'+  $(this).data('targets')) + select#formexp1" ).attr( "disabled", "disabled" )
.siblings().removeAttr('disabled');
  });
});
*/



// this function will bind the enter to the resend button
$(document).keypress(function(e){
    if (e.which == 13){
        $("#resend").click();
    }
});

//here we will set the form boxes to be by default what they were in the url originally

var formexp1value = <?php echo  $exp1Name ; ?>;
document.getElementById("formexp1").value = formexp1value;

var formexp2value = <?php echo  $exp2Name ; ?>;
document.getElementById("formexp2").value = formexp2value;

var formexp3value = <?php echo  $exp3Name ; ?>;
document.getElementById("formexp3").value = formexp3value;


var fexp1anti = "0";
var fexp1anti = $('#formexp1').find(":selected").attr("data-antibody");
document.getElementById("antiformexp1").value = fexp1anti;

var fexp2anti = "0";
var fexp2anti = $('#formexp2').find(":selected").attr("data-antibody");
document.getElementById("antiformexp2").value = fexp2anti;

var fexp3anti = "0";
var fexp3anti = $('#formexp3').find(":selected").attr("data-antibody");
document.getElementById("antiformexp3").value = fexp3anti;

var fexp1cell = "0";
var fexp1cell = $('#formexp1').find(":selected").attr("data-celline");
document.getElementById("cellformexp1").value = fexp1cell;

var fexp2cell = "0";
var fexp2cell = $('#formexp2').find(":selected").attr("data-celline");
document.getElementById("cellformexp2").value = fexp2cell;

var fexp3cell = "0";
var fexp3cell = $('#formexp3').find(":selected").attr("data-celline");
document.getElementById("cellformexp3").value = fexp3cell;

var formmotiveval = <?php echo '"'. $motifid . '"' ;  ?>;
document.getElementById("formmotive").value = formmotiveval;

var limit = <?php echo  $limit ; ?>;
document.getElementById("limit").value = limit;

var low_limit = <?php echo  $low_limit ; ?>;
document.getElementById("low_limit").value = low_limit;

var formmaxid = getAllUrlParams().formmaxid;
document.getElementById("textboxmax").value = formmaxid;

var formminid = getAllUrlParams().formminid;
document.getElementById("textboxmin").value = formminid;

var formminelem = getAllUrlParams().formminelem;
document.getElementById("textboxmnelem").value = formminelem;

var formmaxelem = getAllUrlParams().formmaxelem;
document.getElementById("textboxmxelem").value = formmaxelem;



//here we will set the form boxes to be by default what they were in the url originally
function arata_formularcell(y,x) {
        var el = y.querySelectorAll("[data-celline= \'" + x + "\' ]");
	for(var i = 0; i < el.length; i++) {
    el[i].classList.remove("cell_unselected");
}
}

function arata_formularcell2(y,x) {
        var el = y.querySelectorAll("[data-celline= \'" + x + "\' ]");
        for(var i = 0; i < el.length; i++) {
    el[i].disabled = false;
}
}

function arata_formularanti(y,x) {
        var el = y.querySelectorAll("[data-antibody= \'" + x + "\' ]");
        for(var i = 0; i < el.length; i++) {
    el[i].disabled = false;
}
} 

var formexp1value = <?php echo  $exp1Name ; ?>;
document.getElementById("formexp1").value = formexp1value;

var formexp2value = <?php echo  $exp2Name ; ?>;
document.getElementById("formexp2").value = formexp2value;

var formexp3value = <?php echo  $exp3Name ; ?>;
document.getElementById("formexp3").value = formexp3value;

var fexp1anti = "0";
var fexp1anti = $('#formexp1').find(":selected").attr("data-antibody");
document.getElementById("antiformexp1").value = fexp1anti;

var fexp2anti = "0";
var fexp2anti = $('#formexp2').find(":selected").attr("data-antibody");
document.getElementById("antiformexp2").value = fexp2anti;

var fexp3anti = "0";
var fexp3anti = $('#formexp3').find(":selected").attr("data-antibody");
document.getElementById("antiformexp3").value = fexp3anti;

var fexp1cell = "0";
var fexp1cell = $('#formexp1').find(":selected").attr("data-celline");
document.getElementById("cellformexp1").value = fexp1cell;

var fexp2cell = "0";
var fexp2cell = $('#formexp2').find(":selected").attr("data-celline");
document.getElementById("cellformexp2").value = fexp2cell;

var fexp3cell = "0";
var fexp3cell = $('#formexp3').find(":selected").attr("data-celline");
document.getElementById("cellformexp3").value = fexp3cell;

var formmotive = <?php echo '"'. $motifPart . '"'; ?>;
document.getElementById("formmotive").value = formmotive;

arata_formularcell(formexp1,fexp1cell);
arata_formularcell(formexp2,fexp2cell);
arata_formularcell(formexp3,fexp3cell);
arata_formularanti(formexp1,fexp1anti);
arata_formularanti(formexp2,fexp2anti);
arata_formularanti(formexp3,fexp3anti);

arata_formularcell2(antiformexp1,fexp1cell);
arata_formularcell2(antiformexp2,fexp2cell);
arata_formularcell2(antiformexp3,fexp3cell);


document.getElementById("formmotive").value = formmotiveval;

</script>

</body>

</html>
